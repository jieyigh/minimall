package com.jbh360.trade.service;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;

import org.apache.ibatis.session.RowBounds;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import com.jbh360.common.base.ErrorResult;
import com.jbh360.common.base.SuccessResult;
import com.jbh360.common.exception.SystemErrorCode;
import com.jbh360.common.utils.BeanUtil;
import com.jbh360.common.utils.Constants;
import com.jbh360.common.utils.Constants.OrderServiceDealType;
import com.jbh360.common.utils.Constants.OrderServiceRefundReason;
import com.jbh360.common.utils.DateUtil;
import com.jbh360.common.utils.Page;
import com.jbh360.member.oms.entity.Member;
import com.jbh360.member.oms.mapper.MemberMapper;
import com.jbh360.system.entity.ExpressCompany;
import com.jbh360.system.mapper.ExpressCompanyMapper;
import com.jbh360.trade.dao.OrderServiceDao;
import com.jbh360.trade.entity.Order;
import com.jbh360.trade.entity.OrderDetail;
import com.jbh360.trade.entity.OrderDetailExample;
import com.jbh360.trade.entity.OrderService;
import com.jbh360.trade.entity.OrderServiceExample;
import com.jbh360.trade.entity.OrderServicePicture;
import com.jbh360.trade.entity.OrderServiceRecord;
import com.jbh360.trade.entity.Trade;
import com.jbh360.trade.entity.TradeOrderRecord;
import com.jbh360.trade.mapper.OrderDetailMapper;
import com.jbh360.trade.mapper.OrderMapper;
import com.jbh360.trade.mapper.OrderServiceMapper;
import com.jbh360.trade.mapper.OrderServicePictureMapper;
import com.jbh360.trade.mapper.OrderServiceRecordMapper;
import com.jbh360.trade.mapper.TradeMapper;
import com.jbh360.trade.mapper.TradeOrderRecordMapper;
import com.jbh360.trade.vo.param.OrderServiceParams;
import com.jbh360.trade.vo.rs.OrderResult;
import com.jbh360.trade.vo.rs.OrderServicePictureResult;
import com.jbh360.trade.vo.rs.OrderServicePictureVo;
import com.jbh360.trade.vo.rs.OrderServiceRecordResult;
import com.jbh360.trade.vo.rs.OrderServiceRecordVo;
import com.jbh360.trade.vo.rs.OrderServiceRefundReasonType;
import com.jbh360.trade.vo.rs.OrderServiceResult;
import com.jbh360.trade.vo.rs.OrderServiceVo;

/**
 * 售后单
 * 
 * @author 揭懿
 *
 */
@Service
public class OrderServiceServiceImpl{
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private OrderDetailMapper orderDetailMapper;
    
    @Autowired
    private TradeMapper tradeMapper;
    
    
    @Autowired
    private OrderServiceMapper orderServiceMapper;
    
    @Autowired
    private MemberMapper memberMapper;
    
    @Autowired
    private ExpressCompanyMapper expressCompanyMapper;
    
    @Autowired
    private OrderServicePictureMapper orderServicePictureMapper;
	
	@Autowired
    private OrderServiceRecordMapper orderServiceRecordMapper;
	
	@Autowired
    private OrderServiceDao orderServiceDao;
	
	
	@Autowired
    private TradeOrderRecordMapper tradeOrderRecordMapper;
	
    
	/**
	 * 退款处理方式
	 * @author 揭懿
	 * @param params
	 * @return
	 */
    public List<com.jbh360.trade.vo.rs.OrderServiceDealType> getOrderServiceDealType(OrderServiceParams params){
    	List<com.jbh360.trade.vo.rs.OrderServiceDealType> orderServiceDealTypeList = new ArrayList<com.jbh360.trade.vo.rs.OrderServiceDealType>();
    	Order order = orderMapper.selectByPrimaryKey(params.getFk_order_id());
    	if(null != order){
    		if(null != order.getStateCode()){
    			if(order.getStateCode().equals(Constants.OrderStateCode.待收货.getKey())){
    				return getOrderServiceDealTypeList();
    			}else if(order.getStateCode().equals(Constants.OrderStateCode.待发货.getKey())){
    				com.jbh360.trade.vo.rs.OrderServiceDealType orderServiceDealType = new com.jbh360.trade.vo.rs.OrderServiceDealType();
    	    		orderServiceDealType.setDeal_type(Constants.OrderServiceDealType.我要退款但不退货.getKey());
    	    		orderServiceDealType.setDeal_type_name(Constants.OrderServiceDealType.我要退款但不退货.getValue());
    	    		orderServiceDealTypeList.add(orderServiceDealType);
    	    		return orderServiceDealTypeList;
    			}
    		}
    	}
    	return getOrderServiceDealTypeList();
    }
    
    /**
     * 退款处理方式
     * @author 揭懿
     * @return
     */
    public List<com.jbh360.trade.vo.rs.OrderServiceDealType> getOrderServiceDealTypeList(){
    	List<com.jbh360.trade.vo.rs.OrderServiceDealType> orderServiceDealTypeList = new ArrayList<com.jbh360.trade.vo.rs.OrderServiceDealType>();
    	OrderServiceDealType[] types = Constants.OrderServiceDealType.values();
    	for(OrderServiceDealType type:types){
    		com.jbh360.trade.vo.rs.OrderServiceDealType orderServiceDealType = new com.jbh360.trade.vo.rs.OrderServiceDealType();
    		orderServiceDealType.setDeal_type(type.getKey());
    		orderServiceDealType.setDeal_type_name(type.getValue());
    		orderServiceDealTypeList.add(orderServiceDealType);
    	}
    	return orderServiceDealTypeList;
    }
    
    /**
     * 退款原因
     * @author 揭懿
     * @return
     */
    public List<OrderServiceRefundReasonType> getOrderServiceRefundReasonType(){
    	List<OrderServiceRefundReasonType> orderServiceRefundReasonTypeList = new ArrayList<OrderServiceRefundReasonType>();
    	OrderServiceRefundReason[] types = Constants.OrderServiceRefundReason.values();
    	
    	for(OrderServiceRefundReason type:types){
    		OrderServiceRefundReasonType orderServiceRefundReasonType = new OrderServiceRefundReasonType();
    		orderServiceRefundReasonType.setRefund_reason_type_id(type.getKey());
    		orderServiceRefundReasonType.setRefund_reason_type_name(type.getValue());
    		orderServiceRefundReasonTypeList.add(orderServiceRefundReasonType);
    	}
    	
    	return orderServiceRefundReasonTypeList;
    }
    
    //申请
    public OrderServiceResult apply(OrderServiceParams params,ErrorResult error){
    	
    	OrderServiceResult orderServiceResult = new OrderServiceResult();
    	
    	
    	OrderService record = new OrderService();
    	
    	Trade trade = null;
    	Order order = null;
    	OrderDetail orderDetail = null;
    	OrderService orderService = null;
    	
    	if(null != params.getFk_trade_id()){
    		trade = tradeMapper.selectByPrimaryKey(params.getFk_trade_id());
    	}    	
    	if(null != params.getFk_order_id()){
    		order = orderMapper.selectByPrimaryKey(params.getFk_order_id());
    	}   
    	
    	
    	
    	if(null != params.getFk_order_detail_id()){
    	    orderDetail = orderDetailMapper.selectByPrimaryKey(params.getFk_order_detail_id());
    	    
    	    if(null == orderDetail){
        		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_DETAIL_NO_EXISTENCE);
        		error.setErrorMessage("订单详细无效");
        		return null;
        	}
    	}
    	
    	if(null == trade){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.TRADE_NO_EXISTENCE);
    		error.setErrorMessage("交易单无效");
    		return null;
    	}
    	if(null == order){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_NO_EXISTENCE);
    		error.setErrorMessage("订单无效");
    		return null;
    	}
    	
    	if(null != order.getStateCode() 
    			&& !order.getStateCode().equals(Constants.OrderStateCode.待发货.getKey()) 
    			&& !order.getStateCode().equals(Constants.OrderStateCode.待收货.getKey())){
    		error.setErrorCode(SystemErrorCode.OrderErrorCode.STATE_INVALID);
    		error.setErrorMessage("订单状态无效");
    		return null;
    	}
    	
    	
    	if(!checkRefundPrice(params)){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.REFUND_PRICE_ERROR);
    		error.setErrorMessage("输入退款金额有误，请重新输入金额");
    		return null;
    	}
    	
    	
    	String userName = getUserName(params);
    	if(userName==null){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.USER_NAME_INVALID);
    		error.setErrorMessage("当前用户名无效");
    		return null;
    	}
    	
    	record.setApplyName(userName);
    	record.setApplyPhone(params.getApply_phone());
    	record.setApplyTime(DateUtil.now());
    	
    	
    	record.setDealType(params.getDeal_type());
    	record.setDealTypeName(Constants.OrderServiceDealType.toMap().get(params.getDeal_type()));
    	
    	record.setStartTime(DateUtil.now());	
    	
    	record.setRefundReasonTypeId(params.getRefund_reason_type_id());
    	record.setRefundReasonTypeName(Constants.OrderServiceRefundReason.getValue(params.getRefund_reason_type_id()).getValue());
    	record.setRefundRemark(params.getApply_remark());
    	record.setMarkedWords(Constants.OrderServiceMarkedWords.等待商家处理退款申请.getValue());
    	
    	BigDecimal refundPrice = new BigDecimal(params.getRefund_price());
    	record.setRefundPrice(refundPrice);
    	
    	
    	record.setStateCode(Constants.OrderServiceStateCode.申请中.getKey());
    	record.setStateName(Constants.OrderServiceStateCode.申请中.getValue());
    	record.setSubStateCode(Constants.OrderServiceSubStateCode.等待商家处理.getKey());
    	record.setSubStateName(Constants.OrderServiceSubStateCode.等待商家处理.getValue());

    	
    	if(null != params.getOrder_service_id()){
    		orderService = orderServiceMapper.selectByPrimaryKey(params.getOrder_service_id());
    		if(orderService!=null){
    			update(orderServiceResult, params, record, orderService, userName);
    		}else{
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_INVALID);
        		error.setErrorMessage("售后单无效");
        		return null;
    		}
    	}else{
    		
    		if(this.checkOrderService(params)){
        		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_INVALID);
        		error.setErrorMessage("售后单已经存在");
        		return null;
        	}
    		
    		save(orderServiceResult, params, record, trade, order, userName);
    	}
    	
    	return orderServiceResult;
    }
    
    
    public void saveHaveFkOrderDetailId(OrderServiceParams params,OrderService record,OrderDetail orderDetail){
    	orderDetail = orderDetailMapper.selectByPrimaryKey(params.getFk_order_detail_id());
    	record.setFkCouponId(orderDetail.getFkCouponId());
    	short refundCount = orderDetail.getBuyCount().shortValue();
    	record.setRefundCount(refundCount);
    	record.setRefundCouponAmount(orderDetail.getGoodsDiscountAmount());
    	//实际支付的
    	record.setRefundGoodsPrice(orderDetail.getPaymentAmount());
    	BigDecimal refundPrice = new BigDecimal(params.getRefund_price());
    	record.setRefundPrice(refundPrice);
    	if(null != orderDetail.getPaymentAmount()){
    		if(refundPrice.compareTo(orderDetail.getPaymentAmount())>0){
        		BigDecimal refundExpressPrice = refundPrice.subtract(orderDetail.getPaymentAmount());
        		//运费
            	record.setRefundExpressPrice(refundExpressPrice);
        	} 
    	}
    }
    
    
    public void saveNotFkOrderDetailId(OrderServiceParams params,OrderService record,OrderDetail orderDetail,Order order){
    	OrderDetailExample example = new OrderDetailExample();
    	OrderDetailExample.Criteria criteria = example.createCriteria();
    	criteria.andFkOrderIdEqualTo(params.getFk_order_id());
    	List<OrderDetail> orderDetails = orderDetailMapper.selectByExample(example);
    	if(null != orderDetails && !orderDetails.isEmpty()){
    		orderDetail = orderDetails.get(0);
    	}
    	record.setFkCouponId(order.getFkCouponId());
    	
    	record.setRefundCouponAmount(order.getOrderDiscountTotalAmount());
    	//实际支付的
    	record.setRefundGoodsPrice(order.getOrderPaymentAmount());
    	BigDecimal refundPrice = new BigDecimal(params.getRefund_price());
    	record.setRefundPrice(refundPrice);
    	if(null != order.getOrderPaymentAmount()){
    		if(refundPrice.compareTo(order.getOrderPaymentAmount())>0){
        		BigDecimal refundExpressPrice = refundPrice.subtract(order.getOrderPaymentAmount());
        		//运费
            	record.setRefundExpressPrice(refundExpressPrice);
        	} 
    	}
    }
    
    
    public OrderServiceResult update(OrderServiceResult orderServiceResult,OrderServiceParams params,OrderService record,OrderService orderService,String userName){
		record.setId(orderService.getId());
    	record.setLastUpdateTime(DateUtil.now());
    	record.setLastUpdateUserId(params.getMember_id());
    	orderServiceMapper.updateByPrimaryKeySelective(record);
    	
    	//售后单操作记录
		OrderServiceRecord recRecord = new OrderServiceRecord();
		recRecord.setApplyPhone(record.getApplyPhone());
    	recRecord.setCreateTime(DateUtil.now());
    	recRecord.setCreateUserId(params.getMember_id());
    	recRecord.setDealType(record.getDealType());
    	recRecord.setDealTypeName(record.getDealTypeName());
    	
    	recRecord.setFkServiceId(record.getId());
    	
    	recRecord.setOpSign(Constants.OrderServiceOpSign.修改了退款申请等待商家处理.getValue());
    	recRecord.setOpTime(DateUtil.now());
    	recRecord.setOpType(Constants.OrderServiceRecordOpType.修改退款申请.getKey());
    	recRecord.setOpTypeName(Constants.OrderServiceRecordOpType.修改退款申请.getValue());
    	recRecord.setOpUserId(params.getMember_id());
    	recRecord.setOpUserName(userName);
    	recRecord.setOpUserType(Constants.OrderServiceOpUserType.买家.getKey());
    	recRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.买家.getValue());
    	
    	recRecord.setRefundPrice(record.getRefundPrice());
    	recRecord.setRefundReasonTypeName(record.getRefundReasonTypeName());
    	recRecord.setRefundRemark(record.getRefundRemark());
    	
    	orderServiceRecordMapper.insertSelective(recRecord);
		//
		if(null != params.getBuyer_express_pic_rsurl() && params.getBuyer_express_pic_rsurl().length>0){
			for(String rsurl:params.getBuyer_express_pic_rsurl()){
    			OrderServicePicture picRecord = new OrderServicePicture();
    	    	picRecord.setCreateTime(DateUtil.now());
    	    	picRecord.setFkServiceId(record.getId());
    	    	picRecord.setFkServiceRecordId(recRecord.getId());
    	    	picRecord.setOpType(Constants.OrderServiceRecordOpType.修改退款申请.getKey());
    	    	picRecord.setOpTypeName(Constants.OrderServiceRecordOpType.修改退款申请.getValue());
    	    	picRecord.setOpUserType(Constants.OrderServiceOpUserType.买家.getKey());
    	    	picRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.买家.getValue());
    	    	picRecord.setPicRsurl(rsurl);
    	    	
    	    	orderServicePictureMapper.insertSelective(picRecord);
			}
		}
		
		orderServiceResult.setId(record.getId());
		orderServiceResult.setBillNo(orderService.getBillNo());
		return orderServiceResult;
    }
    
    public OrderServiceResult save(OrderServiceResult orderServiceResult,OrderServiceParams params,OrderService record,Trade trade,Order order,String userName){
    	String billNo = null;
    	
    	OrderDetail orderDetail = new OrderDetail();
    	
    	if(null != params.getFk_order_detail_id()){
    	    saveHaveFkOrderDetailId(params, record, orderDetail);
    	}else{
    		saveNotFkOrderDetailId(params, record, orderDetail, order);
    	}
    	
    	//TODO
    	//售后单号
    	billNo = DateUtil.format(DateUtil.createDateFormat("yyyyMMddHHmmssSSS"), DateUtil.now());
    	record.setBillNo(billNo);
    	
    	record.setCreateTime(DateUtil.now());
    	record.setCreateUserId(params.getMember_id());
    	
    	
    	record.setFkCustomerId(trade.getFkMemberId());
    	record.setFkOrderDetailId(params.getFk_order_detail_id());
    	record.setFkOrderId(params.getFk_order_id());
    	
    	record.setFkShopMemberId(order.getFkBuyeStoreMemberId());
    	record.setFkShopStoreId(order.getFkBuyerStoreId());
    	record.setFkShopSupplierId(order.getFkSellerSupplierId());
    	
    	record.setFkSupplierId(order.getFkSellerSupplierId());
    	record.setFkSupplierMemberId(order.getFkSellerMemberId());
    	record.setFkSupplierStoreId(order.getFkSellerStoreId());
    	
    	record.setFkTradeId(params.getFk_trade_id());
    	
    	record.setOrderType(order.getOrderType());
    	
    	record.setProductLogoRsurl(orderDetail.getProductLogoRsurl());
    	record.setProductName(orderDetail.getProductName());
    	record.setSkuPropertyValue(orderDetail.getSkuPropertyValue());
    	
    	
    	orderServiceMapper.insertSelective(record);
    	
    	//订单表
    	Order newOrder = new Order();
    	newOrder.setId(order.getId());
    	newOrder.setServiceState(Constants.OrderServiceState.售后中.getKey());
    	newOrder.setLastUpdateTime(DateUtil.now());
    	newOrder.setLastUpdateUserId(params.getMember_id());
    	
    	orderMapper.updateByPrimaryKeySelective(newOrder);
    	
    	//订单记录
    	TradeOrderRecord tradeOrderRecord = new TradeOrderRecord();
    	tradeOrderRecord.setFkOrderId(order.getId());
    	//tradeOrderRecord.setFkRecordDetailId(fkRecordDetailId);
    	tradeOrderRecord.setFkTradeId(order.getFkTradeId());
    	tradeOrderRecord.setOpContent("申请售后");
    	tradeOrderRecord.setOpTime(DateUtil.now());
    	tradeOrderRecord.setOpType(Constants.TradeOrderRecordOpType.申请售后.getValue());
    	tradeOrderRecord.setOpUserId(params.getMember_id());
    	tradeOrderRecord.setOpUserName(userName);
    	tradeOrderRecord.setOpUserType(Constants.OrderServiceOpUserType.买家.getKey());
    	tradeOrderRecord.setRemark("");
    	tradeOrderRecordMapper.insertSelective(tradeOrderRecord);
    	
    	//售后记录
    	OrderServiceRecord recRecord = new OrderServiceRecord();
    	recRecord.setApplyPhone(params.getApply_phone());
    	recRecord.setCreateTime(DateUtil.now());
    	recRecord.setCreateUserId(params.getMember_id());
    	recRecord.setDealType(params.getDeal_type());
    	recRecord.setDealType(Constants.OrderServiceDealType.toMap().get(params.getDeal_type()));
    	
    	recRecord.setFkServiceId(record.getId());
    	
    	recRecord.setOpSign(Constants.OrderServiceOpSign.发起了退款申请等待商家处理.getValue());
    	recRecord.setOpTime(DateUtil.now());
    	recRecord.setOpType(Constants.OrderServiceRecordOpType.申请退款.getKey());
    	recRecord.setOpTypeName(Constants.OrderServiceRecordOpType.申请退款.getValue());
    	recRecord.setOpUserId(params.getMember_id());
    	recRecord.setOpUserName(userName);
    	recRecord.setOpUserType(Constants.OrderServiceOpUserType.买家.getKey());
    	recRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.买家.getValue());
    	
    	recRecord.setRefundPrice(record.getRefundPrice());
    	recRecord.setRefundReasonTypeName(record.getRefundReasonTypeName());
    	recRecord.setRefundRemark(record.getRefundRemark());
    	
    	orderServiceRecordMapper.insertSelective(recRecord);
    	//
		if(null != params.getBuyer_express_pic_rsurl() && params.getBuyer_express_pic_rsurl().length>0){
			for(String rsurl:params.getBuyer_express_pic_rsurl()){
				OrderServicePicture picRecord = new OrderServicePicture();
		    	picRecord.setCreateTime(DateUtil.now());
		    	picRecord.setFkServiceId(record.getId());
		    	picRecord.setFkServiceRecordId(recRecord.getId());
		    	picRecord.setOpType(Constants.OrderServiceRecordOpType.申请退款.getKey());
		    	picRecord.setOpTypeName(Constants.OrderServiceRecordOpType.申请退款.getValue());
		    	picRecord.setOpUserType(Constants.OrderServiceOpUserType.买家.getKey());
		    	picRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.买家.getValue());
		    	picRecord.setPicRsurl(rsurl);
		    	
		    	orderServicePictureMapper.insertSelective(picRecord);
			}
		}
		
		orderServiceResult.setId(record.getId());
		orderServiceResult.setBillNo(billNo);
		return orderServiceResult;
    }
    
    //查询售后单是否已经申请过
    public boolean checkOrderService(OrderServiceParams params){
    	if(null != params.getFk_order_detail_id()){
    		OrderServiceExample example = new OrderServiceExample();
    		OrderServiceExample.Criteria criteria = example.createCriteria();
    		criteria.andFkOrderDetailIdEqualTo(params.getFk_order_detail_id());
    		List<OrderService> orderServiceLists = orderServiceMapper.selectByExample(example);
    		if(null != orderServiceLists && !orderServiceLists.isEmpty()){
    			return true;
    		}
    	}else{
			OrderServiceExample example = new OrderServiceExample();
    		OrderServiceExample.Criteria criteria = example.createCriteria();
    		criteria.andFkOrderIdEqualTo(params.getFk_order_id());
    		List<OrderService> orderServiceLists = orderServiceMapper.selectByExample(example);
    		if(null != orderServiceLists && !orderServiceLists.isEmpty()){
    			return true;
    		}
    	}
    	return false;
    }
    
    //获取退款最大值
    public BigDecimal getMaxRefundPrice(OrderServiceParams params){
    	BigDecimal maxRefundPrice = new BigDecimal(0);
    	//是否第一次退款
    	boolean first = false;
    	
    	BigDecimal freightAmount = new BigDecimal(0);
    	
    	Order order = new Order();
    	
    	if(null != params.getFk_order_id()){
    		
    		OrderServiceExample example = new OrderServiceExample();
    		OrderServiceExample.Criteria criteria = example.createCriteria();
    		criteria.andFkOrderIdEqualTo(params.getFk_order_id());
    		List<OrderService> orderServiceLists = orderServiceMapper.selectByExample(example);
    		if(null != orderServiceLists && !orderServiceLists.isEmpty()){
    			first = true;
    		}
    		order = orderMapper.selectByPrimaryKey(params.getFk_order_id());
    		if(null != order && !first){
    			if(null != order.getOrderFreightAmount())
    				freightAmount = order.getOrderFreightAmount();
    		}
    	}
    	
    	if(null != params.getFk_order_detail_id()){
    		//商品级别的退款
    		OrderDetail orderDetail = orderDetailMapper.selectByPrimaryKey(params.getFk_order_detail_id());
    		if(null != orderDetail && null != orderDetail.getPaymentAmount()){
    			BigDecimal paymentAmount = orderDetail.getPaymentAmount();
        		maxRefundPrice = paymentAmount.add(freightAmount);
    		}
    	}else{
    		//订单级别的退款
    		if(null != order.getOrderPaymentAmount()){
    			BigDecimal orderPaymentAmount = order.getOrderPaymentAmount();
        		maxRefundPrice = orderPaymentAmount.add(freightAmount);
    		}
    	}
    	return maxRefundPrice;
    }
    
    //检查退款
    public boolean checkRefundPrice(OrderServiceParams params){
    	boolean check = true;
    	BigDecimal refundPrice = new BigDecimal(params.getRefund_price());
    	BigDecimal maxRefundPrice = this.getMaxRefundPrice(params);
    	
    	//maxRefundPrice必须大于或者等于refundPrice
		if(maxRefundPrice.compareTo(refundPrice)<0){
			//TODO
			check = false;
		}
		return check;
    }
    
    /**
     * 判断退款金额接口
     * @param params
     * @param successResult
     * @param error
     */
    public void checkPrice(OrderServiceParams params,SuccessResult successResult,ErrorResult error){
    	if(null != params.getFk_order_id()){
    		Order order = orderMapper.selectByPrimaryKey(params.getFk_order_id());
    		if(null==order){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_NO_EXISTENCE);
        		error.setErrorMessage("订单无效");
        		return;
    		}
    	}
    	
    	if(null != params.getFk_order_detail_id()){
    		OrderDetail orderDetail = orderDetailMapper.selectByPrimaryKey(params.getFk_order_detail_id());
    		if(null == orderDetail){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_DETAIL_NO_EXISTENCE);
        		error.setErrorMessage("订单详细无效");
        		return;
    		}
    	}
    	successResult.setIs_success(checkRefundPrice(params));
    }
    
    /**
     * 获取用户名
     * @author 揭懿
     * @param params
     * @return
     */
    public String getUserName(OrderServiceParams params){
    	String userName = null;
    	if(null != params.getMember_id()){
    		Member member = memberMapper.selectByPrimaryKey(params.getMember_id());
        	if(null != member){
        		userName = member.getRealName();
        	}
    	}
    	return userName;
    }
    
    /**
     * 填写退货物流
     * @author 揭懿
     * @param params
     * @param successResult
     * @param error
     */
    @Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT)
    public void setExpress(OrderServiceParams params,SuccessResult successResult,ErrorResult error){
    	String userName = getUserName(params);
    	if(userName==null){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.USER_NAME_INVALID);
    		error.setErrorMessage("当前用户名无效");
    		return;
    	}
    	
    	OrderService orderService = orderServiceMapper.selectByPrimaryKey(params.getOrder_service_id());
    	String buyerExpressCompanyName = null;
    	if(null != orderService){
    		
    		if(null != orderService.getDealType() 
    				&& orderService.getDealType().equals(Constants.OrderServiceDealType.我要退款但不退货.getKey())){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_DEAL_TYPE_INVALID);
        		error.setErrorMessage("售后单处理方式不正确");
        		return;
    		}
    		
    		if(null != orderService.getStateCode() 
    				&& !orderService.getStateCode().equals(Constants.OrderServiceStateCode.处理中.getKey())){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_STATE_INVALID);
        		error.setErrorMessage("售后单状态不正确，正确状态是处理中");
        		return;
    		}
    		
    		if(null != orderService.getSubStateCode() 
    				&& !orderService.getSubStateCode().equals(Constants.OrderServiceSubStateCode.等待买家处理.getKey())){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_SUBSTATE_INVALID);
        		error.setErrorMessage("售后单子状态不正确，正确状态是等待买家处理");
        		return;
    		}
    		
    		if(null != orderService.getServiceTips() 
    				&& !orderService.getServiceTips().equals(Constants.OrderServiceTips.商家同意退货.getValue())){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_TIPS_INVALID);
        		error.setErrorMessage("售后单阶段不正确，正确阶段是商家同意退货");
        		return;
    		}
    		
    		OrderService record = new OrderService();
    		record.setId(orderService.getId());
    		
    		record.setBuyerExpressBillNo(params.getBuyer_express_bill_no());
        	record.setBuyerExpressCompanyId(params.getBuyer_express_company_id());
        	
        	ExpressCompany expressCompany = expressCompanyMapper.selectByPrimaryKey(params.getBuyer_express_company_id());
        	if(null != expressCompany){
        		buyerExpressCompanyName = expressCompany.getName();
        	}else{
        		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_EXPRESS_COMPANY_INVALID);
        		error.setErrorMessage("物流方式无效");
        		return;
        	}
        		
        	record.setBuyerExpressCompanyName(buyerExpressCompanyName);
        	record.setBuyerExpressTime(DateUtil.now());
        	
        	record.setLastUpdateTime(DateUtil.now());
        	record.setLastUpdateUserId(params.getMember_id());
        	
        	record.setMarkedWords(Constants.OrderServiceMarkedWords.等待商家确认收货.getValue());
        	
        	record.setServiceTips(Constants.OrderServiceTips.等待商家确认收货.getValue());
        	record.setSubStateCode(Constants.OrderServiceSubStateCode.等待商家处理.getKey());
        	record.setSubStateName(Constants.OrderServiceSubStateCode.等待商家处理.getValue());
        	
    		orderServiceMapper.updateByPrimaryKeySelective(record);
    		
    		
    		//售后单操作记录
    		OrderServiceRecord recRecord = new OrderServiceRecord();
        	recRecord.setBuyerExpressBillNo(params.getBuyer_express_bill_no());
        	recRecord.setBuyerExpressCompanyId(params.getBuyer_express_company_id());
        	recRecord.setBuyerExpressCompanyName(buyerExpressCompanyName);
        	recRecord.setCreateTime(DateUtil.now());
        	recRecord.setCreateUserId(params.getMember_id());
        	
        	recRecord.setFkServiceId(record.getId());
        	
        	recRecord.setOpSign(Constants.OrderServiceOpSign.已退货等待商家确认收货.getValue());
        	recRecord.setOpTime(DateUtil.now());
        	recRecord.setOpType(Constants.OrderServiceRecordOpType.填写退货物流信息.getKey());
        	recRecord.setOpTypeName(Constants.OrderServiceRecordOpType.填写退货物流信息.getValue());
        	recRecord.setOpUserId(params.getMember_id());
        	recRecord.setOpUserName(userName);
        	recRecord.setOpUserType(Constants.OrderServiceOpUserType.买家.getKey());
        	recRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.买家.getValue());
        	
        	
        	recRecord.setReturnPhone(params.getReturn_phone());
        	recRecord.setReturnRemark(params.getReturn_remark());
    		
        	orderServiceRecordMapper.insertSelective(recRecord);
    		//
    		if(null != params.getBuyer_express_pic_rsurl() && params.getBuyer_express_pic_rsurl().length>0){
    			for(String rsurl:params.getBuyer_express_pic_rsurl()){
    				OrderServicePicture picRecord = new OrderServicePicture();
    		    	picRecord.setCreateTime(DateUtil.now());
    		    	picRecord.setFkServiceId(record.getId());
    		    	picRecord.setFkServiceRecordId(recRecord.getId());
    		    	picRecord.setOpType(Constants.OrderServiceRecordOpType.填写退货物流信息.getKey());
    		    	picRecord.setOpTypeName(Constants.OrderServiceRecordOpType.填写退货物流信息.getValue());
    		    	picRecord.setOpUserType(Constants.OrderServiceOpUserType.买家.getKey());
    		    	picRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.买家.getValue());
    		    	picRecord.setPicRsurl(rsurl);
    		    	
    		    	orderServicePictureMapper.insertSelective(picRecord);
    			}
    		}
    		
    		successResult.setIs_success(true);
    	}else{
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_INVALID);
    		error.setErrorMessage("售后单无效");
    		return;
    	}
    }
    
    
    private boolean checkApplyState(OrderService orderService,ErrorResult error){
    	
    	if(null != orderService.getStateCode() 
				&& !orderService.getStateCode().equals(Constants.OrderServiceStateCode.申请中.getKey())){
			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_STATE_INVALID);
    		error.setErrorMessage("售后单状态不正确，正确状态是申请中");
    		return true;
		}
		
		if(null != orderService.getSubStateCode() 
				&& !orderService.getSubStateCode().equals(Constants.OrderServiceSubStateCode.等待商家处理.getKey())){
			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_SUBSTATE_INVALID);
    		error.setErrorMessage("售后单子状态不正确，正确状态是等待商家处理");
    		return true;
		}
		
		return false;
    }
    
    
    /**
     * 同意退款or同意退货
     * @author 揭懿
     * @param params
     * @param successResult
     * @param error
     */
    @Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT)
    public void agree(OrderServiceParams params,SuccessResult successResult,ErrorResult error){
    	String userName = getUserName(params);
    	if(userName==null){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.USER_NAME_INVALID);
    		error.setErrorMessage("当前用户名无效");
    		return;
    	}
    	
    	OrderService orderService = orderServiceMapper.selectByPrimaryKey(params.getOrder_service_id());
    	
    	if(null != orderService){
    		
    		if(this.checkApplyState(orderService, error)){
    			return;
    		}
    		
    		if(null != orderService.getCreateUserId() && !params.getMember_id().equals(orderService.getCreateUserId())){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.USER_NAME_INVALID);
        		error.setErrorMessage("该售后单不属于该用户");
        		return;
    		}
    		
    		OrderService record = new OrderService();
    		record.setId(orderService.getId());
        	
        	record.setLastUpdateTime(DateUtil.now());
        	record.setLastUpdateUserId(params.getMember_id());
        	
        	//售后单操作记录
        	OrderServiceRecord recRecord = new OrderServiceRecord();
        	
        	recRecord.setFkServiceId(record.getId());
        	
        	recRecord.setOpSign(Constants.OrderServiceOpSign.同意退款给买家.getValue());
        	recRecord.setOpTime(DateUtil.now());
        	recRecord.setOpType(Constants.OrderServiceRecordOpType.同意退款.getKey());
        	recRecord.setOpTypeName(Constants.OrderServiceRecordOpType.同意退款.getValue());
        	recRecord.setOpUserId(params.getMember_id());
        	recRecord.setOpUserName(userName);
        	recRecord.setOpUserType(Constants.OrderServiceOpUserType.商家.getKey());
        	recRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.商家.getValue());
        	recRecord.setCreateTime(DateUtil.now());
        	recRecord.setCreateUserId(params.getMember_id());
        	
        	recRecord.setRefundPrice(orderService.getRefundPrice());
        	
        	if(orderService.getDealType().equals(Constants.OrderServiceDealType.我要退款但不退货.getKey())){
        		this.agreeRefund(record, recRecord);
        	}else if(orderService.getDealType().equals(Constants.OrderServiceDealType.我要退款并退货.getKey())){
        		if(null == params.getReturn_address()){
        			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.RETURN_ADDRESS_IS_NULL);
            		error.setErrorMessage("退货地址不能为空");
            		return;
        		}
        		
        		this.agreeReturn(params, record, recRecord);
        	}
        	
        	successResult.setIs_success(true);
        	
    	}else{
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_INVALID);
    		error.setErrorMessage("售后单无效");
    		return;
    	}
    }
    
    /**
     * 同意（我要退款但不退货）
     * @author 揭懿
     * @param record
     * @param recRecord
     */
    @Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT)
    private void agreeRefund(OrderService record,OrderServiceRecord recRecord){
    	record.setEndTime(DateUtil.now());
    	
    	record.setStateCode(Constants.OrderServiceStateCode.已完成.getKey());
    	record.setStateName(Constants.OrderServiceStateCode.已完成.getValue());
    	record.setSubStateCode(Constants.OrderServiceSubStateCode.同意退款.getKey());
    	record.setSubStateName(Constants.OrderServiceSubStateCode.同意退款.getValue());
    	
    	record.setMarkedWords(Constants.OrderServiceMarkedWords.退款成功.getValue());
    	
    	orderServiceMapper.updateByPrimaryKeySelective(record);
    	//TODO
    	//增加退款单
    	
    	orderServiceRecordMapper.insertSelective(recRecord);
    }
    
    /**
     * 同意（我要退款并退货）
     * @author 揭懿
     * @param params
     * @param record
     * @param recRecord
     */
    @Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT)
    private void agreeReturn(OrderServiceParams params,OrderService record,OrderServiceRecord recRecord){
    	record.setStateCode(Constants.OrderServiceStateCode.处理中.getKey());
    	record.setStateName(Constants.OrderServiceStateCode.处理中.getValue());
    	record.setSubStateCode(Constants.OrderServiceSubStateCode.等待买家处理.getKey());
    	record.setSubStateName(Constants.OrderServiceSubStateCode.等待买家处理.getValue());
    	
    	record.setMarkedWords(Constants.OrderServiceMarkedWords.商家已同意退款请退货给商家.getValue());
    	record.setServiceTips(Constants.OrderServiceTips.商家同意退货.getValue());
    	orderServiceMapper.updateByPrimaryKeySelective(record);
    	
    	recRecord.setReturnAddress(params.getReturn_address());
    	orderServiceRecordMapper.insertSelective(recRecord);
    }
    
    /**
     * 拒绝售后
     * @author 揭懿
     * @param params
     * @param successResult
     * @param error
     */
    @Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT)
    public void refuse(OrderServiceParams params,SuccessResult successResult,ErrorResult error){
    	
    	String userName = getUserName(params);
    	
    	if(userName==null){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.USER_NAME_INVALID);
    		error.setErrorMessage("当前用户名无效");
    		return;
    	}
    	
    	OrderService orderService = orderServiceMapper.selectByPrimaryKey(params.getOrder_service_id());
    	
    	if(null != orderService){
    		
    		if(this.checkApplyState(orderService, error)){
    			return;
    		}
    		
    		OrderService record = new OrderService();
    		record.setId(orderService.getId());
    		
    		record.setLastUpdateTime(DateUtil.now());
        	record.setLastUpdateUserId(params.getMember_id());
    		
    		record.setSellerSupplierAcceptAdminId(params.getMember_id());
        	record.setSellerSupplierAcceptAdminName(userName);
        	record.setSellerSupplierAcceptTime(DateUtil.now());
        	record.setSellerSupplierFeedbackResult(Constants.OrderServiceSellerSupplierFeedbackResult.拒绝.getKey());
        	record.setSellerSupplierRefuseReason(params.getRefuse_reason());
        	
        	record.setStateCode(Constants.OrderServiceStateCode.处理中.getKey());
        	record.setStateName(Constants.OrderServiceStateCode.处理中.getValue());
        	record.setSubStateCode(Constants.OrderServiceSubStateCode.等待买家处理.getKey());
        	record.setSubStateName(Constants.OrderServiceSubStateCode.等待买家处理.getValue());
        	
        	record.setMarkedWords(Constants.OrderServiceMarkedWords.商家拒绝退款给买家.getValue());
    		record.setServiceTips(Constants.OrderServiceTips.商家拒绝.getValue());
    		
    		orderServiceMapper.updateByPrimaryKeySelective(record);
    		
    		//售后单操作记录
    		OrderServiceRecord recRecord = new OrderServiceRecord();
    		
        	recRecord.setCreateTime(DateUtil.now());
        	recRecord.setCreateUserId(params.getMember_id());
        	
        	recRecord.setFkServiceId(record.getId());
        	
        	recRecord.setOpSign(Constants.OrderServiceOpSign.商家拒绝退款给买家.getValue());
        	recRecord.setOpTime(DateUtil.now());
        	recRecord.setOpType(Constants.OrderServiceRecordOpType.拒绝退款.getKey());
        	recRecord.setOpTypeName(Constants.OrderServiceRecordOpType.拒绝退款.getValue());
        	recRecord.setOpUserId(params.getMember_id());
        	recRecord.setOpUserName(userName);
        	recRecord.setOpUserType(Constants.OrderServiceOpUserType.商家.getKey());
        	recRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.商家.getValue());
        	
        	recRecord.setRefuseReason(params.getRefuse_reason());
        	
        	
    		orderServiceRecordMapper.insertSelective(recRecord);
    		
    		successResult.setIs_success(true);
    	}else{
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_INVALID);
    		error.setErrorMessage("售后单无效");
    		return;
    	}
    }
    
    
    private boolean checkDealState(OrderService orderService,ErrorResult error){
    	
    	if(null != orderService.getDealType() 
				&& orderService.getDealType().equals(Constants.OrderServiceDealType.我要退款但不退货.getKey())){
			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_DEAL_TYPE_INVALID);
    		error.setErrorMessage("售后单处理方式不正确");
    		return true;
		}
		
		if(null != orderService.getStateCode() 
				&& !orderService.getStateCode().equals(Constants.OrderServiceStateCode.处理中.getKey())){
			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_STATE_INVALID);
    		error.setErrorMessage("售后单状态不正确，正确状态是处理中");
    		return true;
		}
		
		if(null != orderService.getSubStateCode() 
				&& !orderService.getSubStateCode().equals(Constants.OrderServiceSubStateCode.等待商家处理.getKey())){
			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_SUBSTATE_INVALID);
    		error.setErrorMessage("售后单子状态不正确，正确状态是等待商家处理");
    		return true;
		}
		
		if(null != orderService.getServiceTips() 
				&& !orderService.getServiceTips().equals(Constants.OrderServiceTips.等待商家确认收货.getValue())){
			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_TIPS_INVALID);
    		error.setErrorMessage("售后单阶段不正确，正确阶段是等待商家确认收货");
    		return true;
		}
		
		return false;
    }
    
    /**
     * 确认收货并退款
     * @author 揭懿
     * @param params
     * @param successResult
     * @param error
     */
    @Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT)
    public void confirmReceiving(OrderServiceParams params,SuccessResult successResult,ErrorResult error){
    	String userName = getUserName(params);
    	
    	if(userName==null){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.USER_NAME_INVALID);
    		error.setErrorMessage("当前用户名无效");
    		return;
    	}
    	
    	OrderService orderService = orderServiceMapper.selectByPrimaryKey(params.getOrder_service_id());
    	
    	if(null != orderService){
    		
    		if(this.checkDealState(orderService, error)){
    			return;
    		}
    		
    		
    		OrderService record = new OrderService();
    		record.setId(orderService.getId());
    		
    		record.setEndTime(DateUtil.now());
    		
    		record.setLastUpdateTime(DateUtil.now());
        	record.setLastUpdateUserId(params.getMember_id());
        	
        	record.setMarkedWords(Constants.OrderServiceMarkedWords.退款成功.getValue());
        	
        	record.setSellerSupplierComfirmAdminId(params.getMember_id());
        	record.setSellerSupplierComfirmAdminName(userName);
        	record.setStateCode(Constants.OrderServiceStateCode.已完成.getKey());
        	record.setStateName(Constants.OrderServiceStateCode.已完成.getValue());
        	record.setSubStateCode(Constants.OrderServiceSubStateCode.同意退款.getKey());
        	record.setSubStateName(Constants.OrderServiceSubStateCode.同意退款.getValue());
        	
        	orderServiceMapper.updateByPrimaryKeySelective(record);
        	
        	//TODO
        	//增加退款单
        	
        	OrderServiceRecord recRecord = new OrderServiceRecord();
        	recRecord.setCreateTime(DateUtil.now());
        	recRecord.setCreateUserId(params.getMember_id());
        	
        	recRecord.setFkServiceId(record.getId());
        	
        	recRecord.setOpSign(Constants.OrderServiceOpSign.商家确认收货并退款.getValue());
        	recRecord.setOpTime(DateUtil.now());
        	recRecord.setOpType(Constants.OrderServiceRecordOpType.确认收货并退款.getKey());
        	recRecord.setOpTypeName(Constants.OrderServiceRecordOpType.确认收货并退款.getValue());
        	recRecord.setOpUserId(params.getMember_id());
        	recRecord.setOpUserName(userName);
        	recRecord.setOpUserType(Constants.OrderServiceOpUserType.商家.getKey());
        	recRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.商家.getValue());
        	
        	recRecord.setRefundPrice(record.getRefundPrice());
        	recRecord.setReturnAddress(record.getReturnAddress());
        	
        	orderServiceRecordMapper.insertSelective(recRecord);
        	
        	successResult.setIs_success(true);
        	
    	}else{
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_INVALID);
    		error.setErrorMessage("售后单无效");
    		return;
    	}
    }
    
    /**
     * 拒绝确认收货
     * @author 揭懿
     * @param params
     * @param successResult
     * @param error
     */
    @Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT)
    public void refuseReceiving(OrderServiceParams params,SuccessResult successResult,ErrorResult error){
    	String userName = getUserName(params);
    	
    	if(userName==null){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.USER_NAME_INVALID);
    		error.setErrorMessage("当前用户名无效");
    		return;
    	}
    	
    	OrderService orderService = orderServiceMapper.selectByPrimaryKey(params.getOrder_service_id());
    	
    	if(null != orderService){
    		
    		if(this.checkDealState(orderService, error)){
    			return;
    		}
    		
    		OrderService record = new OrderService();
    		record.setId(orderService.getId());
    		
        	record.setLastUpdateTime(DateUtil.now());
        	record.setLastUpdateUserId(params.getMember_id());
        	
        	record.setMarkedWords(Constants.OrderServiceMarkedWords.商家拒绝确认收货.getValue());
        	
        	record.setServiceTips(Constants.OrderServiceTips.商家拒绝.getValue());
        	
        	record.setSubStateCode(Constants.OrderServiceSubStateCode.等待买家处理.getKey());
        	record.setSubStateName(Constants.OrderServiceSubStateCode.等待买家处理.getValue());
        	
        	orderServiceMapper.updateByPrimaryKeySelective(record);
        	
        	OrderServiceRecord recRecord = new OrderServiceRecord();
        	recRecord.setCreateTime(DateUtil.now());
        	recRecord.setCreateUserId(params.getMember_id());
        	
        	recRecord.setFkServiceId(record.getId());
        	
        	recRecord.setOpSign(Constants.OrderServiceOpSign.商家拒绝确认收货.getValue());
        	recRecord.setOpTime(DateUtil.now());
        	recRecord.setOpType(Constants.OrderServiceRecordOpType.拒绝确认收货.getKey());
        	recRecord.setOpTypeName(Constants.OrderServiceRecordOpType.拒绝确认收货.getValue());
        	recRecord.setOpUserId(params.getMember_id());
        	recRecord.setOpUserName(userName);
        	recRecord.setOpUserType(Constants.OrderServiceOpUserType.商家.getKey());
        	recRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.商家.getValue());
        	
        	recRecord.setRefundPrice(record.getRefundPrice());
        	recRecord.setReturnAddress(record.getReturnAddress());
        	
        	orderServiceRecordMapper.insertSelective(recRecord);
        	
        	successResult.setIs_success(true);
        	
    	}else{
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_INVALID);
    		error.setErrorMessage("售后单无效");
    		return;
    	}
    }
    
    /**
     * 申请平台客服介入
     * @author 揭懿
     * @param params
     * @param successResult
     * @param error
     */
	@Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT)
    public void consult(OrderServiceParams params,SuccessResult successResult,ErrorResult error){
    	String userName = getUserName(params);
    	
    	if(userName==null){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.USER_NAME_INVALID);
    		error.setErrorMessage("当前用户名无效");
    		return;
    	}
    	
    	OrderService orderService = orderServiceMapper.selectByPrimaryKey(params.getOrder_service_id());
    	
    	if(null != orderService){
    		
    		if(null != orderService.getStateCode() 
    				&& !orderService.getStateCode().equals(Constants.OrderServiceStateCode.处理中.getKey())){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_STATE_INVALID);
        		error.setErrorMessage("售后单状态不正确，正确状态是处理中");
        		return;
    		}
    		
    		if(null != orderService.getSubStateCode() 
    				&& !orderService.getSubStateCode().equals(Constants.OrderServiceSubStateCode.等待买家处理.getKey())){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_SUBSTATE_INVALID);
        		error.setErrorMessage("售后单子状态不正确，正确状态是等待买家处理");
        		return;
    		}
    		
    		if(null != orderService.getServiceTips() 
    				&& !orderService.getServiceTips().equals(Constants.OrderServiceTips.商家拒绝.getValue())){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_TIPS_INVALID);
        		error.setErrorMessage("售后单阶段不正确，正确阶段是商家拒绝");
        		return;
    		}
    		
    		OrderService record = new OrderService();
    		record.setId(orderService.getId());
    		
        	record.setLastUpdateTime(DateUtil.now());
        	record.setLastUpdateUserId(params.getMember_id());
        	
        	record.setMarkedWords(Constants.OrderServiceMarkedWords.申请掌柜客服介入.getValue());
        	record.setMediationBy(userName);
        	
        	record.setPlatformMediationState(Constants.OrderServicePlatformMediationState.申请中.getKey());
        	
        	
        	record.setServiceTips(Constants.OrderServiceTips.等待平台客服介入.getValue());
        	record.setStateCode(Constants.OrderServiceStateCode.平台客服介入协商中.getKey());
        	record.setStateName(Constants.OrderServiceStateCode.平台客服介入协商中.getValue());
        	record.setSubStateCode(Constants.OrderServiceSubStateCode.平台客服介入.getKey());
        	record.setSubStateName(Constants.OrderServiceSubStateCode.平台客服介入.getValue());
        	
        	orderServiceMapper.updateByPrimaryKeySelective(record);
        	
        	OrderServiceRecord recRecord = new OrderServiceRecord();
        	recRecord.setCreateTime(DateUtil.now());
        	recRecord.setCreateUserId(params.getMember_id());
        	
        	recRecord.setFkServiceId(record.getId());
        	
        	recRecord.setOpSign(Constants.OrderServiceOpSign.申请掌柜客服介入.getValue());
        	recRecord.setOpTime(DateUtil.now());
        	recRecord.setOpType(Constants.OrderServiceRecordOpType.申请平台客服介入.getKey());
        	recRecord.setOpTypeName(Constants.OrderServiceRecordOpType.申请平台客服介入.getValue());
        	recRecord.setOpUserId(params.getMember_id());
        	recRecord.setOpUserName(userName);
        	recRecord.setOpUserType(Constants.OrderServiceOpUserType.买家.getKey());
        	recRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.买家.getValue());
        	
        	orderServiceRecordMapper.insertSelective(recRecord);
        	
        	successResult.setIs_success(true);
        	
    	}else{
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_INVALID);
    		error.setErrorMessage("售后单无效");
    		return;
    	}
    }
    
    /**
     * 撤销平台客服介入
     * @author 揭懿
     * @param params
     * @param successResult
     * @param error
     */
	@Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT)
    public void cancelConsult(OrderServiceParams params,SuccessResult successResult,ErrorResult error){
    	String userName = getUserName(params);
    	if(userName==null){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.USER_NAME_INVALID);
    		error.setErrorMessage("当前用户名无效");
    		return;
    	}
    	
    	OrderService orderService = orderServiceMapper.selectByPrimaryKey(params.getOrder_service_id());
    	
    	if(null != orderService){
    		
    		if(null != orderService.getStateCode() 
    				&& !orderService.getStateCode().equals(Constants.OrderServiceStateCode.平台客服介入协商中.getKey())){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_STATE_INVALID);
        		error.setErrorMessage("售后单状态不正确，正确状态是平台客服介入协商中");
        		return;
    		}
    		
    		if(null != orderService.getSubStateCode() 
    				&& !orderService.getSubStateCode().equals(Constants.OrderServiceSubStateCode.平台客服介入.getKey())){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_SUBSTATE_INVALID);
        		error.setErrorMessage("售后单子状态不正确，正确状态是平台客服介入");
        		return;
    		}
    		
    		OrderService record = new OrderService();
    		record.setId(orderService.getId());
    		
        	record.setLastUpdateTime(DateUtil.now());
        	record.setLastUpdateUserId(params.getMember_id());
        	
        	record.setMarkedWords(Constants.OrderServiceMarkedWords.撤销客服介入.getValue());
        	
        	record.setStateCode(Constants.OrderServiceStateCode.申请中.getKey());
        	record.setStateName(Constants.OrderServiceStateCode.申请中.getValue());
        	record.setSubStateCode(Constants.OrderServiceSubStateCode.等待商家处理.getKey());
        	record.setSubStateName(Constants.OrderServiceSubStateCode.等待商家处理.getValue());
        	
        	orderServiceMapper.updateByPrimaryKeySelective(record);
        	
        	OrderServiceRecord recRecord = new OrderServiceRecord();
        	recRecord.setCreateTime(DateUtil.now());
        	recRecord.setCreateUserId(params.getMember_id());
        	
        	recRecord.setFkServiceId(record.getId());
        	
        	recRecord.setOpSign(Constants.OrderServiceOpSign.撤销客服介入.getValue());
        	recRecord.setOpTime(DateUtil.now());
        	recRecord.setOpType(Constants.OrderServiceRecordOpType.撤销客服介入.getKey());
        	recRecord.setOpTypeName(Constants.OrderServiceRecordOpType.撤销客服介入.getValue());
        	recRecord.setOpUserId(params.getMember_id());
        	recRecord.setOpUserName(userName);
        	recRecord.setOpUserType(Constants.OrderServiceOpUserType.买家.getKey());
        	recRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.买家.getValue());
        	
        	orderServiceRecordMapper.insertSelective(recRecord);
        	
        	successResult.setIs_success(true);
    	}else{
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_INVALID);
    		error.setErrorMessage("售后单无效");
    		return;
    	}
    }
    
    /**
     * 关闭售后
     * @author 揭懿
     * @param params
     * @param successResult
     * @param error
     */
	@Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT)
    public void close(OrderServiceParams params,SuccessResult successResult,ErrorResult error){
    	String userName = getUserName(params);
    	if(userName==null){
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.USER_NAME_INVALID);
    		error.setErrorMessage("当前用户名无效");
    		return;
    	}
    	
    	OrderService orderService = orderServiceMapper.selectByPrimaryKey(params.getOrder_service_id());
    	
    	if(null != orderService){
    		
    		if(this.checkApplyState(orderService, error)){
    			return;
    		}
    		
    		if(null != orderService.getCreateUserId() && !params.getMember_id().equals(orderService.getCreateUserId())){
    			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.USER_NAME_INVALID);
        		error.setErrorMessage("该售后单不属于该用户");
        		return;
    		}
    		
    		OrderService record = new OrderService();
    		record.setId(orderService.getId());
    	
        	record.setEndTime(DateUtil.now());
        	
        	record.setLastUpdateTime(DateUtil.now());
        	record.setLastUpdateUserId(params.getMember_id());
        	
        	record.setMarkedWords(Constants.OrderServiceMarkedWords.买家关闭退款服务.getValue());
        	
        	record.setStateCode(Constants.OrderServiceStateCode.已关闭.getKey());
        	record.setStateName(Constants.OrderServiceStateCode.已关闭.getValue());
        	record.setSubStateCode(Constants.OrderServiceSubStateCode.售后撤销.getKey());
        	record.setSubStateName(Constants.OrderServiceSubStateCode.售后撤销.getValue());
        	
        	orderServiceMapper.updateByPrimaryKeySelective(record);
        	
        	OrderServiceRecord recRecord = new OrderServiceRecord();
        	recRecord.setCreateTime(DateUtil.now());
        	recRecord.setCreateUserId(params.getMember_id());
        	
        	recRecord.setFkServiceId(record.getId());
        	
        	recRecord.setOpSign(Constants.OrderServiceOpSign.买家关闭退款服务.getValue());
        	recRecord.setOpTime(DateUtil.now());
        	recRecord.setOpType(Constants.OrderServiceRecordOpType.关闭申请退款.getKey());
        	recRecord.setOpTypeName(Constants.OrderServiceRecordOpType.关闭申请退款.getValue());
        	recRecord.setOpUserId(params.getMember_id());
        	recRecord.setOpUserName(userName);
        	recRecord.setOpUserType(Constants.OrderServiceOpUserType.买家.getKey());
        	recRecord.setOpUserTypeName(Constants.OrderServiceOpUserType.买家.getValue());
        	
        	orderServiceRecordMapper.insertSelective(recRecord);
        	
        	successResult.setIs_success(true);
    	}else{
    		error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_INVALID);
    		error.setErrorMessage("售后单无效");
    		return;
    	}
    }
	
	/**
	 * 获取售后单详情
	 * @param params
	 * @param error
	 * @return
	 */
	public OrderServiceResult getOrderServiceResult(OrderServiceParams params,ErrorResult error){
		OrderServiceResult result = new OrderServiceResult();
		OrderServiceVo orderServiceVo = orderServiceDao.getOrderServiceVo(params.getOrder_service_id());
		if(null != orderServiceVo){
			BeanUtil.copyProperties(result, orderServiceVo);
			
			List<OrderServiceRecordResult> recordResults = new ArrayList<OrderServiceRecordResult>();
			for(OrderServiceRecordVo recordVo:orderServiceVo.getRecordVos()){
				
				OrderServiceRecordResult recordResult = new OrderServiceRecordResult();
				BeanUtil.copyProperties(recordResult, recordVo);
				
				
				List<OrderServicePictureResult> picResults = new ArrayList<OrderServicePictureResult>();
				for(OrderServicePictureVo picVo:recordVo.getPicVos()){
					OrderServicePictureResult picResult = new OrderServicePictureResult();
					BeanUtil.copyProperties(picResult, picVo);
					picResults.add(picResult);
				}
				recordResult.setPicResults(picResults);
				
				recordResults.add(recordResult);
			}
			
			result.setRecordResults(recordResults);
			
			OrderResult orderResult = new OrderResult();
			if(null != orderServiceVo.getOrderVo()){
				BeanUtil.copyProperties(orderResult, orderServiceVo.getOrderVo());
			}
			
			result.setOrderResult(orderResult);
			
			
		}else{
			error.setErrorCode(SystemErrorCode.OrderServiceErrorCode.ORDER_SERVICE_INVALID);
    		error.setErrorMessage("售后单无效");
    		return result;
		}
		return result;
	}
	
	
	/**
	 * 售后单列表
	 * @param page
	 * @param params
	 * @return
	 */
	public Page<OrderServiceResult> getOrderServiceLists(Page<OrderServiceResult> page, OrderServiceParams params){
		
		List<OrderServiceVo> serviceVos = orderServiceDao.getOrderServiceVoLists(new RowBounds(page.getFirst()-1, page.getPageSize()), params);
		
		List<OrderServiceResult> result = new ArrayList<OrderServiceResult>();
		
		for(OrderServiceVo serviceVo:serviceVos){
			OrderServiceResult orderServiceResult = new OrderServiceResult();
			BeanUtil.copyProperties(orderServiceResult, serviceVo);
			result.add(orderServiceResult);
		}
		
		Long count = orderServiceDao.countOrderServiceVoLists(params);
		page.setResult(result);
		page.setTotalCount(count);
		return page;
	}
    
    
}